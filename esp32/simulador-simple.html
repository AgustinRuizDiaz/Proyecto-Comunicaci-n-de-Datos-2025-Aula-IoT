<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador ESP32 - Aula 203</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }

        .header h1 {
            color: #1f2937;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .header p {
            color: #6b7280;
            font-size: 14px;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-top: 10px;
        }

        .status-badge.sending {
            background: #dcfce7;
            color: #166534;
        }

        .status-badge.idle {
            background: #fef3c7;
            color: #92400e;
        }

        .info-box {
            background: #f9fafb;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
        }

        .info-label {
            color: #6b7280;
            font-weight: 500;
        }

        .info-value {
            color: #1f2937;
            font-weight: 600;
        }

        .sensors-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .sensor-card {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .sensor-card.active {
            border-color: #16a34a;
            background: #f0fdf4;
        }

        .sensor-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .sensor-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            background: #e5e7eb;
        }

        .sensor-card.active .sensor-icon {
            background: #dcfce7;
        }

        .sensor-icon svg {
            width: 24px;
            height: 24px;
            stroke: #6b7280;
        }

        .sensor-card.active .sensor-icon svg {
            stroke: #16a34a;
        }

        .sensor-info h3 {
            color: #1f2937;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .sensor-info p {
            color: #6b7280;
            font-size: 13px;
        }

        .sensor-button {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            color: #6b7280;
        }

        .sensor-card.active .sensor-button {
            background: #16a34a;
            color: white;
            border-color: #16a34a;
        }

        .sensor-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .log-section {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            background: #f9fafb;
            border-radius: 10px;
            padding: 15px;
        }

        .log-entry {
            font-size: 12px;
            color: #6b7280;
            padding: 6px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-entry .timestamp {
            color: #9ca3af;
            margin-right: 8px;
        }

        .log-entry.success {
            color: #16a34a;
        }

        .log-entry.error {
            color: #dc2626;
        }

        .log-entry.info {
            color: #2563eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔧 Simulador ESP32</h1>
            <p>Dispositivo IoT - Aula 203</p>
            <div id="statusBadge" class="status-badge idle">
                Iniciando...
            </div>
        </div>

        <div class="info-box">
            <div class="info-row">
                <span class="info-label">IP del Dispositivo:</span>
                <span class="info-value">192.168.1.103</span>
            </div>
            <div class="info-row">
                <span class="info-label">ID del Aula:</span>
                <span class="info-value" id="aulaId">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">Último heartbeat:</span>
                <span class="info-value" id="lastHeartbeat">Nunca</span>
            </div>
        </div>

        <div class="sensors-grid">
            <!-- Sensor de Luz Pin 4 -->
            <div class="sensor-card" id="sensor-light-4">
                <div class="sensor-header">
                    <div class="sensor-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                        </svg>
                    </div>
                    <div class="sensor-info">
                        <h3>Sensor de Luz</h3>
                        <p>Pin 4 • <span id="status-light-4">Apagado</span></p>
                    </div>
                </div>
                <button class="sensor-button" onclick="toggleSensor('light', 4)">
                    Encender
                </button>
            </div>

            <!-- Sensor de Luz Pin 20 -->
            <div class="sensor-card" id="sensor-light-20">
                <div class="sensor-header">
                    <div class="sensor-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                        </svg>
                    </div>
                    <div class="sensor-info">
                        <h3>Sensor de Luz</h3>
                        <p>Pin 20 • <span id="status-light-20">Apagado</span></p>
                    </div>
                </div>
                <button class="sensor-button" onclick="toggleSensor('light', 20)">
                    Encender
                </button>
            </div>

            <!-- Sensor de Ventana Pin 2 -->
            <div class="sensor-card" id="sensor-window-2">
                <div class="sensor-header">
                    <div class="sensor-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <rect x="3" y="3" width="18" height="18" rx="2" stroke-width="2"></rect>
                            <line x1="12" y1="3" x2="12" y2="21" stroke-width="2"></line>
                            <line x1="3" y1="12" x2="21" y2="12" stroke-width="2"></line>
                        </svg>
                    </div>
                    <div class="sensor-info">
                        <h3>Sensor de Ventana</h3>
                        <p>Pin 2 • <span id="status-window-2">Cerrada</span></p>
                    </div>
                </div>
                <button class="sensor-button" onclick="toggleSensor('window', 2)">
                    Abrir
                </button>
            </div>

            <!-- Sensor de Movimiento Pin 3 -->
            <div class="sensor-card" id="sensor-motion-3">
                <div class="sensor-header">
                    <div class="sensor-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                    <div class="sensor-info">
                        <h3>Sensor de Movimiento</h3>
                        <p>Pin 3 • <span id="status-motion-3">Sin detección</span></p>
                    </div>
                </div>
                <button class="sensor-button" onclick="toggleSensor('motion', 3)">
                    Detectar
                </button>
            </div>
        </div>

        <div class="log-section">
            <div style="font-size: 14px; font-weight: 600; color: #1f2937; margin-bottom: 10px;">
                📋 Registro de Actividad
            </div>
            <div id="logContainer">
                <div class="log-entry info">Esperando inicialización...</div>
            </div>
        </div>
    </div>

    <script src="http://localhost:3003/socket.io/socket.io.js"></script>
    <script>
        // Configuración
        const API_BASE_URL = 'http://localhost:3003';
        const WS_URL = 'http://localhost:3003';
        const DEVICE_IP = '192.168.1.103';
        const HEARTBEAT_INTERVAL = 30000; // Heartbeat cada 30 segundos para mantener online

        // Estado local de los sensores (NO consulta BD)
        // TODOS inician en 1 (prendidos/activos)
        const sensors = {
            'light-4': { pin: 4, estado: 1 },
            'light-20': { pin: 20, estado: 1 },
            'window-2': { pin: 2, estado: 1 },
            'motion-3': { pin: 3, estado: 1 }
        };

        let heartbeatInterval = null;
        let socket = null;

        // Función para agregar logs
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `<span class="timestamp">[${timestamp}]</span>${message}`;
            logContainer.insertBefore(logEntry, logContainer.firstChild);
            
            // Mantener solo los últimos 20 logs
            while (logContainer.children.length > 20) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        // Función para actualizar el badge de estado
        function updateStatusBadge(text, isSending = false) {
            const badge = document.getElementById('statusBadge');
            badge.textContent = text;
            badge.className = isSending ? 'status-badge sending' : 'status-badge idle';
        }

        // Función para actualizar la UI de un sensor
        function updateSensorUI(sensorKey, estado) {
            const card = document.getElementById(`sensor-${sensorKey}`);
            const statusSpan = document.getElementById(`status-${sensorKey}`);
            const button = card.querySelector('button');
            
            if (estado === 1) {
                card.classList.add('active');
                if (sensorKey.startsWith('light')) {
                    statusSpan.textContent = 'Encendido';
                    button.textContent = 'Apagar';
                } else if (sensorKey.startsWith('window')) {
                    statusSpan.textContent = 'Abierta';
                    button.textContent = 'Cerrar';
                } else if (sensorKey.startsWith('motion')) {
                    statusSpan.textContent = 'Detectado';
                    button.textContent = 'Desactivar';
                }
            } else {
                card.classList.remove('active');
                if (sensorKey.startsWith('light')) {
                    statusSpan.textContent = 'Apagado';
                    button.textContent = 'Encender';
                } else if (sensorKey.startsWith('window')) {
                    statusSpan.textContent = 'Cerrada';
                    button.textContent = 'Abrir';
                } else if (sensorKey.startsWith('motion')) {
                    statusSpan.textContent = 'Sin detección';
                    button.textContent = 'Detectar';
                }
            }
        }

        // Función para enviar TODOS los datos al backend (solo cuando hay cambios)
        async function sendData(reason = 'cambio') {
            try {
                updateStatusBadge('Enviando datos...', true);
                
                // Construir payload con TODOS los sensores
                const payload = {
                    ip: DEVICE_IP,
                    sensores: [
                        { pin: 4, estado: sensors['light-4'].estado },
                        { pin: 20, estado: sensors['light-20'].estado },
                        { pin: 2, estado: sensors['window-2'].estado },
                        { pin: 3, estado: sensors['motion-3'].estado }
                    ]
                };

                console.log(`📤 Enviando datos (${reason}):`, payload);

                // Timeout controller
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5s timeout

                const response = await fetch(`${API_BASE_URL}/esp32/data`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-esp32-update': 'true'
                    },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Error al enviar datos');
                }

                const data = await response.json();
                
                // Actualizar última señal
                const now = new Date().toLocaleTimeString();
                document.getElementById('lastHeartbeat').textContent = now;
                
                // Verificar si hay comandos pendientes del backend
                if (data.commands && data.commands.length > 0) {
                    addLog(`📥 Recibidos ${data.commands.length} comando(s) del servidor`, 'info');
                    processCommands(data.commands);
                } else {
                    const reasonText = reason === 'inicial' ? 'Estado inicial enviado' : 
                                      reason === 'heartbeat' ? 'Heartbeat enviado' : 
                                      'Cambio enviado correctamente';
                    addLog(`💓 ${reasonText}`, 'success');
                }

                // Actualizar ID del aula si viene en la respuesta
                if (data.aula && data.aula.id) {
                    document.getElementById('aulaId').textContent = data.aula.id;
                }
                
                updateStatusBadge('Activo', false);
            } catch (error) {
                console.error('❌ Error al enviar datos:', error);
                
                if (error.name === 'AbortError') {
                    addLog('⏱️ Timeout: El servidor tardó demasiado en responder', 'error');
                } else if (error.message.includes('Failed to fetch')) {
                    addLog('🔌 Error de red: Verifica que el servidor esté corriendo', 'error');
                } else {
                    addLog(`❌ Error: ${error.message}`, 'error');
                }
                
                updateStatusBadge('Error', false);
                
                // Intentar reconectar después de 5 segundos
                console.log('⏳ Reintentando en 5 segundos...');
                setTimeout(() => {
                    console.log('🔄 Reintentando envío...');
                    sendData('reintento');
                }, 5000);
            }
        }

        // Función para procesar comandos recibidos del backend
        function processCommands(commands) {
            commands.forEach(cmd => {
                const { pin, action } = cmd;
                
                // Buscar el sensor con ese pin
                let sensorKey = null;
                for (let key in sensors) {
                    if (sensors[key].pin === pin) {
                        sensorKey = key;
                        break;
                    }
                }

                if (sensorKey) {
                    // Ejecutar el comando
                    let newState = sensors[sensorKey].estado;
                    
                    if (action === 'on') {
                        newState = 1;
                    } else if (action === 'off') {
                        newState = 0;
                    } else if (action === 'toggle') {
                        newState = sensors[sensorKey].estado === 1 ? 0 : 1;
                    }

                    // Actualizar estado local
                    sensors[sensorKey].estado = newState;
                    updateSensorUI(sensorKey, newState);
                    
                    addLog(`🔄 Comando ejecutado: Pin ${pin} → ${newState === 1 ? 'ON' : 'OFF'}`, 'success');
                    
                    // Enviar confirmación inmediata (después de ejecutar todos los comandos)
                    setTimeout(() => sendData('confirmacion'), 500);
                } else {
                    addLog(`⚠️ Comando para pin ${pin} ignorado (sensor no encontrado)`, 'error');
                }
            });
        }

        // Función para enviar heartbeat periódico (sin cambios en sensores)
        async function sendHeartbeat() {
            await sendData('heartbeat');
        }

        // Función para conectar WebSocket y escuchar comandos
        function connectWebSocket() {
            socket = io(WS_URL);
            
            socket.on('connect', () => {
                addLog('🔌 WebSocket conectado', 'success');
                updateStatusBadge('Conectado', false);
                
                // Identificarse como ESP32
                socket.emit('esp32:identify', { ip: DEVICE_IP });
                addLog(`📡 Identificado como ESP32 ${DEVICE_IP}`, 'info');
            });
            
            socket.on('disconnect', () => {
                addLog('🔌 WebSocket desconectado', 'error');
                updateStatusBadge('Desconectado', false);
            });
            
            // Escuchar comandos del servidor en tiempo real
            socket.on('esp32:command', (command) => {
                console.log('📥 Comando WebSocket recibido:', command);
                addLog(`📥 Comando recibido: Pin ${command.pin} → ${command.action}`, 'info');
                processCommands([command]);
            });
            
            socket.on('error', (error) => {
                console.error('WebSocket error:', error);
                addLog(`❌ Error WebSocket: ${error}`, 'error');
            });
        }

        // Función para cambiar estado de sensor LOCALMENTE
        function toggleSensor(type, pin) {
            const sensorKey = `${type}-${pin}`;
            const sensor = sensors[sensorKey];
            
            if (!sensor) {
                addLog(`⚠️ Sensor no encontrado: ${sensorKey}`, 'error');
                return;
            }
            
            // Cambiar estado localmente
            sensor.estado = sensor.estado === 1 ? 0 : 1;
            updateSensorUI(sensorKey, sensor.estado);
            
            const stateText = sensor.estado === 1 ? 'activado' : 'desactivado';
            addLog(`🔘 Cambio local: Pin ${pin} ${stateText}`, 'info');
            
            // Enviar cambio inmediatamente al servidor
            sendData('cambio');
        }

        // Inicialización automática al cargar la página
        window.addEventListener('DOMContentLoaded', async () => {
            addLog('🚀 ESP32 iniciado con IP: ' + DEVICE_IP, 'info');
            addLog('📡 Modo: Envío solo cuando hay cambios', 'info');
            
            // Actualizar UI de todos los sensores al estado inicial (todos en 1)
            Object.keys(sensors).forEach(key => {
                updateSensorUI(key, sensors[key].estado);
            });
            
            // Enviar estado inicial (todos los sensores en 1)
            await sendData('inicial');
            
            // Iniciar heartbeat periódico cada 30 segundos (solo para mantener online)
            heartbeatInterval = setInterval(sendHeartbeat, HEARTBEAT_INTERVAL);
            
            // Conectar WebSocket para recibir comandos en tiempo real
            connectWebSocket();
            
            addLog('✅ Simulador activo - Todos los sensores prendidos', 'success');
            addLog('⚡ Comandos en tiempo real vía WebSocket', 'info');
            updateStatusBadge('Activo', false);
        });

        // Limpiar al cerrar
        window.addEventListener('beforeunload', () => {
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            if (socket) socket.disconnect();
        });
    </script>
</body>
</html>
